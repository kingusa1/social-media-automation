{% extends "base.html" %}
{% set active_page = "executions" %}
{% block title %}Executions{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="bi bi-list-check me-2"></i>Executions</h3>
    <select class="form-select form-select-sm w-auto" id="filterProject">
        <option value="">All Projects</option>
        <option value="infiniteo">Infiniteo</option>
        <option value="yourops">YourOps</option>
    </select>
</div>

<div class="card">
    <div class="table-responsive-wrapper">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Project</th>
                    <th>Status</th>
                    <th>Time</th>
                    <th>Articles</th>
                    <th class="d-none d-md-table-cell">Model</th>
                    <th class="d-none d-md-table-cell">Fallback</th>
                </tr>
            </thead>
            <tbody id="runsTable">
                <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Run Detail Modal (fullscreen on mobile) -->
<div class="modal fade" id="runDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Run Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="runDetailBody">Loading...</div>
        </div>
    </div>
</div>

<nav class="mt-3">
    <ul class="pagination pagination-sm justify-content-center" id="pagination"></ul>
</nav>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPage = 1;

async function loadRuns() {
    const projectId = document.getElementById('filterProject').value;
    const params = new URLSearchParams({page: currentPage, per_page: 20});
    if (projectId) params.set('project_id', projectId);

    const data = await fetchAPI(`/api/runs?${params}`);
    const tbody = document.getElementById('runsTable');

    if (data.runs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No executions found</td></tr>';
        return;
    }

    tbody.innerHTML = data.runs.map(run => {
        const duration = run.completed_at
            ? Math.round((new Date(run.completed_at) - new Date(run.started_at)) / 1000) + 's'
            : 'Running...';
        return `
        <tr style="cursor:pointer" onclick="showRunDetail(${run.id})">
            <td>${run.id}</td>
            <td><strong>${run.project_id}</strong></td>
            <td><span class="badge bg-${statusColor(run.status)}">${run.status}</span></td>
            <td>${formatTime(run.started_at)}</td>
            <td>${run.articles_new || 0}/${run.articles_fetched || 0}</td>
            <td class="d-none d-md-table-cell">${run.ai_model_used || '-'}</td>
            <td class="d-none d-md-table-cell">${run.used_fallback ? '<span class="text-warning">Yes</span>' : 'No'}</td>
        </tr>`;
    }).join('');

    // Pagination
    const totalPages = Math.ceil(data.total / data.per_page);
    const pagination = document.getElementById('pagination');
    if (totalPages <= 1) { pagination.innerHTML = ''; return; }
    let pages = '';
    for (let i = 1; i <= totalPages; i++) {
        pages += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="currentPage=${i}; loadRuns(); return false;">${i}</a></li>`;
    }
    pagination.innerHTML = pages;
}

async function showRunDetail(runId) {
    const data = await fetchAPI(`/api/runs/${runId}`);
    const body = document.getElementById('runDetailBody');

    const logsHtml = (data.log_details || []).map(log => `
        <tr>
            <td><span class="badge bg-${statusColor(log.status)}">${log.status}</span></td>
            <td><strong>${log.step}</strong></td>
            <td class="small">${log.message}</td>
        </tr>
    `).join('');

    const postsHtml = (data.posts || []).map(post => `
        <div class="card mb-2">
            <div class="card-header d-flex justify-content-between py-2">
                <span><i class="bi bi-${post.platform === 'linkedin' ? 'linkedin' : 'twitter-x'}"></i> ${post.platform}</span>
                <span>${post.is_fallback ? '<span class="badge bg-warning">Fallback</span>' : '<span class="badge bg-success">AI</span>'}</span>
            </div>
            <div class="card-body p-2"><pre class="mb-0 small" style="white-space:pre-wrap">${post.content}</pre></div>
        </div>
    `).join('');

    body.innerHTML = `
        <h6>Step Log</h6>
        <div class="table-responsive-wrapper">
            <table class="table table-sm mb-4">
                <thead><tr><th>Status</th><th>Step</th><th>Message</th></tr></thead>
                <tbody>${logsHtml || '<tr><td colspan="3">No logs</td></tr>'}</tbody>
            </table>
        </div>
        <h6>Generated Posts</h6>
        ${postsHtml || '<p class="text-muted">No posts generated</p>'}
        ${data.selected_article ? `<h6 class="mt-3">Selected Article</h6><p class="small"><a href="${data.selected_article.url}" target="_blank">${data.selected_article.title}</a> (score: ${data.selected_article.score})</p>` : ''}
    `;

    new bootstrap.Modal(document.getElementById('runDetailModal')).show();
}

document.getElementById('filterProject').addEventListener('change', () => { currentPage = 1; loadRuns(); });
loadRuns();
</script>
{% endblock %}
