{% extends "base.html" %}
{% set active_page = "executions" %}
{% block title %}Executions{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-list-check me-2"></i>Pipeline Executions</h3>
    <div>
        <select class="form-select form-select-sm d-inline-block w-auto" id="filterProject">
            <option value="">All Projects</option>
            <option value="infiniteo">Infiniteo</option>
            <option value="yourops">YourOps</option>
        </select>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Project</th>
                    <th>Trigger</th>
                    <th>Status</th>
                    <th>Started</th>
                    <th>Duration</th>
                    <th>Articles</th>
                    <th>AI Model</th>
                    <th>Fallback</th>
                    <th>Selected Article</th>
                </tr>
            </thead>
            <tbody id="runsTable">
                <tr><td colspan="10" class="text-center text-muted">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Run Detail Modal -->
<div class="modal fade" id="runDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Run Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="runDetailBody">Loading...</div>
        </div>
    </div>
</div>

<nav class="mt-3">
    <ul class="pagination justify-content-center" id="pagination"></ul>
</nav>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPage = 1;

async function loadRuns() {
    const projectId = document.getElementById('filterProject').value;
    const params = new URLSearchParams({page: currentPage, per_page: 20});
    if (projectId) params.set('project_id', projectId);

    const data = await fetchAPI(`/api/runs?${params}`);
    const tbody = document.getElementById('runsTable');

    if (data.runs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No executions found</td></tr>';
        return;
    }

    tbody.innerHTML = data.runs.map(run => {
        const duration = run.completed_at
            ? Math.round((new Date(run.completed_at) - new Date(run.started_at)) / 1000) + 's'
            : 'Running...';
        return `
        <tr style="cursor:pointer" onclick="showRunDetail(${run.id})">
            <td>${run.id}</td>
            <td><strong>${run.project_id}</strong></td>
            <td><span class="badge bg-info">${run.trigger_type}</span></td>
            <td><span class="badge bg-${statusColor(run.status)}">${run.status}</span></td>
            <td>${formatTime(run.started_at)}</td>
            <td>${duration}</td>
            <td>${run.articles_new}/${run.articles_fetched}</td>
            <td>${run.ai_model_used || '-'}</td>
            <td>${run.used_fallback ? '<span class="text-warning">Yes</span>' : 'No'}</td>
            <td title="${run.selected_article_title || ''}">${(run.selected_article_title || '-').substring(0, 40)}</td>
        </tr>`;
    }).join('');
}

async function showRunDetail(runId) {
    const data = await fetchAPI(`/api/runs/${runId}`);
    const body = document.getElementById('runDetailBody');

    const logsHtml = (data.log_details || []).map(log => `
        <tr>
            <td><span class="badge bg-${statusColor(log.status)}">${log.status}</span></td>
            <td><strong>${log.step}</strong></td>
            <td>${log.message}</td>
            <td><small>${formatTime(log.timestamp)}</small></td>
        </tr>
    `).join('');

    const postsHtml = (data.posts || []).map(post => `
        <div class="card mb-2">
            <div class="card-header d-flex justify-content-between">
                <span><i class="bi bi-${post.platform === 'linkedin' ? 'linkedin' : 'twitter-x'}"></i> ${post.platform}</span>
                <span>${post.is_fallback ? '<span class="badge bg-warning">Fallback</span>' : '<span class="badge bg-success">AI</span>'}</span>
            </div>
            <div class="card-body"><pre class="mb-0" style="white-space:pre-wrap">${post.content}</pre></div>
        </div>
    `).join('');

    body.innerHTML = `
        <h6>Step-by-Step Log</h6>
        <table class="table table-sm mb-4">
            <thead><tr><th>Status</th><th>Step</th><th>Message</th><th>Time</th></tr></thead>
            <tbody>${logsHtml || '<tr><td colspan="4">No logs</td></tr>'}</tbody>
        </table>
        <h6>Generated Posts</h6>
        ${postsHtml || '<p class="text-muted">No posts generated</p>'}
        ${data.selected_article ? `<h6 class="mt-3">Selected Article</h6><p><a href="${data.selected_article.url}" target="_blank">${data.selected_article.title}</a> (score: ${data.selected_article.score})</p>` : ''}
    `;

    new bootstrap.Modal(document.getElementById('runDetailModal')).show();
}

document.getElementById('filterProject').addEventListener('change', () => { currentPage = 1; loadRuns(); });
loadRuns();
</script>
{% endblock %}
