{% extends "base.html" %}
{% set active_page = "profiles" %}
{% block title %}Profiles{% endblock %}

{% block content %}
<h3 class="mb-4"><i class="bi bi-person-badge me-2"></i>Social Media Profiles</h3>

{% raw %}
<div id="profilesContainer" class="row g-3">
    <div class="col-12 text-center text-muted">Loading...</div>
</div>
{% endraw %}
{% endblock %}

{% block extra_scripts %}
<script>
async function loadProfiles() {
    const profiles = await fetchAPI('/api/profiles');
    const container = document.getElementById('profilesContainer');

    // Group by project
    const grouped = {};
    for (const p of profiles) {
        if (!grouped[p.project_id]) grouped[p.project_id] = [];
        grouped[p.project_id].push(p);
    }

    let html = '';
    for (const [projectId, projectProfiles] of Object.entries(grouped)) {
        const color = projectId === 'infiniteo' ? 'primary' : 'success';
        const linkedinProfiles = projectProfiles.filter(p => p.platform === 'linkedin');
        const anyConnected = linkedinProfiles.some(p => p.has_token);

        html += `<div class="col-12"><h5 class="text-${color}">${projectId.charAt(0).toUpperCase() + projectId.slice(1)}</h5></div>`;

        // Single LinkedIn card per project
        html += `
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span><i class="bi bi-linkedin me-1"></i> LINKEDIN</span>
                    <span class="badge bg-${anyConnected ? 'success' : 'secondary'}">${anyConnected ? 'Connected' : 'Not Connected'}</span>
                </div>
                <div class="card-body">`;

        // Show status for each sub-profile
        for (const p of linkedinProfiles) {
            const status = !p.has_token ? 'Not Connected'
                : p.token_expires_at && new Date(p.token_expires_at) < new Date() ? 'Expired'
                : 'Connected';
            const statusColor = status === 'Connected' ? 'success' : status === 'Expired' ? 'warning' : 'secondary';
            const icon = p.account_type === 'personal' ? 'person' : 'building';

            html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><i class="bi bi-${icon} me-1"></i> ${p.account_type.charAt(0).toUpperCase() + p.account_type.slice(1)}: ${p.platform_user_id || 'Auto-detected on connect'}</span>
                        <span class="badge bg-${statusColor}">${status}${p.is_active ? '' : ' (inactive)'}</span>
                    </div>`;
        }

        html += `
                    <hr>
                    <a href="/auth/linkedin/start?project_id=${projectId}"
                       class="btn btn-${anyConnected ? 'outline-' : ''}primary">
                        <i class="bi bi-linkedin me-1"></i>${anyConnected ? 'Reconnect' : 'Connect'} LinkedIn
                    </a>
                    <small class="text-muted ms-2">One connection handles both personal & organization</small>
                </div>
            </div>
        </div>`;
    }

    container.innerHTML = html || '<div class="col-12 text-muted">No profiles found</div>';
}

// Check URL params for success/error messages
const params = new URLSearchParams(window.location.search);
if (params.get('success')) showToast('LinkedIn connected successfully! Personal & organization profiles auto-detected.', 'success');
if (params.get('error')) showToast(`Error: ${decodeURIComponent(params.get('error'))}`, 'danger');

loadProfiles();
</script>
{% endblock %}
