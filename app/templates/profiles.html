{% extends "base.html" %}
{% set active_page = "profiles" %}
{% block title %}Connections{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
    <div>
        <h3 class="mb-1" style="font-weight:700;letter-spacing:-0.3px"><i class="bi bi-plug-fill me-2" style="color:var(--accent-green)"></i>Connections</h3>
        <p style="color:var(--text-muted);font-size:0.85rem;margin:0">Connect your social media accounts to each project</p>
    </div>
</div>

{% raw %}
<div id="profilesContainer">
    <div class="page-loader">
        <div class="spinner-border spinner-border-sm"></div>
        Loading connections...
    </div>
</div>
{% endraw %}
{% endblock %}

{% block extra_scripts %}
<script>
var allProjects = [];
var allProfiles = [];

async function loadData() {
    var results = await Promise.all([fetchAPI('/api/projects'), fetchAPI('/api/profiles')]);
    allProjects = results[0];
    allProfiles = results[1];
    render();
}

function getStatus(profile) {
    if (!profile || !profile.has_token) return { text: 'Not Connected', cls: 'disconnected', color: 'secondary' };
    if (profile.token_expires_at) {
        var ts = profile.token_expires_at;
        if (!ts.endsWith('Z') && ts.indexOf('+') === -1 && ts.lastIndexOf('-') < 10) ts += 'Z';
        var exp = new Date(ts);
        var days = Math.floor((exp - new Date()) / 86400000);
        if (days < 0) return { text: 'Expired', cls: 'disconnected', color: 'danger' };
        if (days < 7) return { text: 'Expires in ' + days + 'd', cls: 'expiring', color: 'warning' };
        return { text: 'Connected (' + days + 'd left)', cls: 'connected', color: 'success' };
    }
    return { text: 'Connected', cls: 'connected', color: 'success' };
}

function render() {
    var container = document.getElementById('profilesContainer');
    var html = '';

    for (var idx = 0; idx < allProjects.length; idx++) {
        var project = allProjects[idx];
        var pid = project.id;
        var pName = project.display_name;
        var projColor = pid === 'infiniteo' ? 'primary' : 'success';
        var profiles = allProfiles.filter(function(p) { return p.project_id === pid; });
        var linkedinProfiles = profiles.filter(function(p) { return p.platform === 'linkedin'; });
        var twitterProfile = profiles.find(function(p) { return p.platform === 'twitter'; });
        var linkedinConnected = linkedinProfiles.some(function(p) { return p.has_token; });
        var twitterConnected = twitterProfile && twitterProfile.has_token;
        var anyConnected = linkedinConnected || twitterConnected;

        html += '<div style="margin-bottom:36px">';
        html += '<div class="d-flex align-items-center gap-2 mb-3">' +
            '<h5 style="font-weight:700;margin:0">' + pName + '</h5>' +
            '<span class="badge bg-' + (anyConnected ? 'success' : 'secondary') + '" style="font-size:0.7rem">' + (anyConnected ? 'Active' : 'Setup Needed') + '</span>' +
        '</div>';

        html += '<div class="row g-3">';

        // ====== LINKEDIN ======
        html += '<div class="col-12 col-lg-6"><div class="platform-card">';
        html += '<div class="platform-header linkedin">' +
            '<div class="d-flex align-items-center gap-2"><i class="bi bi-linkedin fs-5"></i><strong>LinkedIn</strong></div>' +
            '<span class="badge ' + (linkedinConnected ? 'bg-light text-dark' : 'bg-dark bg-opacity-50') + '">' +
                '<span class="status-dot ' + (linkedinConnected ? 'connected' : 'disconnected') + '"></span>' +
                (linkedinConnected ? 'Connected' : 'Not Connected') +
            '</span>' +
        '</div>';
        html += '<div class="platform-body">';

        if (linkedinConnected) {
            for (var li = 0; li < linkedinProfiles.length; li++) {
                var p = linkedinProfiles[li];
                var st = getStatus(p);
                var icon = p.account_type === 'personal' ? 'person-fill' : 'building-fill';
                var label = p.account_type === 'personal' ? 'Personal' : 'Organization';
                html += '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:var(--radius-sm);background:var(--bg-glass);margin-bottom:8px;border:1px solid var(--border-color)">' +
                    '<div><i class="bi bi-' + icon + ' me-1"></i><span style="font-size:0.85rem;font-weight:500">' + label + '</span>' +
                        (p.platform_user_id ? '<span style="color:var(--text-muted);font-size:0.8rem;margin-left:6px">(' + p.platform_user_id + ')</span>' : '') +
                    '</div>' +
                    '<span class="badge bg-' + st.color + '">' + st.text + '</span>' +
                '</div>';
            }
            html += '<div style="font-size:0.78rem;color:var(--text-muted);margin-top:10px"><i class="bi bi-shield-check me-1" style="color:var(--accent-green)"></i>Auto-detects personal + organization. Token auto-refreshes.</div>';
            html += '<div class="d-flex gap-2 mt-3 flex-wrap">' +
                '<a href="/auth/linkedin/start?project_id=' + pid + '" class="btn btn-outline-primary" style="font-size:0.85rem;font-weight:550"><i class="bi bi-arrow-clockwise me-1"></i>Reconnect</a>' +
                '<button class="btn btn-outline-danger" style="font-size:0.82rem" onclick="disconnectPlatform(\'' + pid + '\', \'linkedin\')"><i class="bi bi-x-circle me-1"></i>Disconnect</button>' +
            '</div>';
        } else {
            html += '<p style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6;margin-bottom:16px"><i class="bi bi-info-circle me-1"></i>Click below to connect your LinkedIn. Auto-detects your personal profile and any organization pages you admin. <strong>One click, done.</strong></p>';
            html += '<a href="/auth/linkedin/start?project_id=' + pid + '" class="btn btn-primary w-100" style="font-weight:600"><i class="bi bi-linkedin me-2"></i>Connect LinkedIn</a>';
        }

        html += '</div></div></div>';

        // ====== TWITTER ======
        html += '<div class="col-12 col-lg-6"><div class="platform-card">';
        html += '<div class="platform-header twitter">' +
            '<div class="d-flex align-items-center gap-2"><i class="bi bi-twitter-x fs-5"></i><strong>Twitter / X</strong></div>' +
            '<span class="badge ' + (twitterConnected ? 'bg-light text-dark' : 'bg-dark bg-opacity-50') + '">' +
                '<span class="status-dot ' + (twitterConnected ? 'connected' : 'disconnected') + '"></span>' +
                (twitterConnected ? 'Connected' : 'Not Connected') +
            '</span>' +
        '</div>';
        html += '<div class="platform-body">';

        if (twitterConnected) {
            html += '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:var(--radius-sm);background:var(--bg-glass);margin-bottom:8px;border:1px solid var(--border-color)">' +
                '<div><i class="bi bi-key-fill me-1"></i><span style="font-size:0.85rem;font-weight:500">API Connected</span></div>' +
                '<span class="badge bg-success">Active</span>' +
            '</div>';
            html += '<div style="font-size:0.78rem;color:var(--text-muted);margin-top:10px"><i class="bi bi-key-fill me-1" style="color:var(--accent-cyan)"></i>Using stored API credentials. No expiration.</div>';
            html += '<div class="d-flex gap-2 mt-3 flex-wrap">' +
                '<button class="btn btn-outline-info" style="font-size:0.85rem;font-weight:550" onclick="toggleTwitterForm(\'' + pid + '\')"><i class="bi bi-pencil me-1"></i>Update Keys</button>' +
                '<button class="btn btn-outline-danger" style="font-size:0.82rem" onclick="disconnectPlatform(\'' + pid + '\', \'twitter\')"><i class="bi bi-x-circle me-1"></i>Disconnect</button>' +
            '</div>';
            html += '<div id="twitter-form-' + pid + '" style="display:none;margin-top:16px">';
        } else {
            html += '<p style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6;margin-bottom:16px"><i class="bi bi-info-circle me-1"></i>Twitter requires API keys from the <a href="https://developer.x.com/en/portal/dashboard" target="_blank" style="color:var(--accent-cyan);font-weight:550">X Developer Portal</a>. Create a free app, then paste your 4 keys below.</p>';
            html += '<div id="twitter-form-' + pid + '" style="margin-top:0">';
        }

        html += '<div class="mb-2"><label class="form-label" style="font-size:0.82rem"><i class="bi bi-key me-1"></i>API Key</label><input type="text" class="form-control form-control-sm" id="tw-key-' + pid + '" placeholder="e.g. xAi1bC2dE3fG4h..." style="font-family:monospace;font-size:0.82rem"></div>' +
            '<div class="mb-2"><label class="form-label" style="font-size:0.82rem"><i class="bi bi-key-fill me-1"></i>API Secret</label><input type="password" class="form-control form-control-sm" id="tw-secret-' + pid + '" placeholder="e.g. kL5mN6oP7qR8s..." style="font-family:monospace;font-size:0.82rem"></div>' +
            '<div class="mb-2"><label class="form-label" style="font-size:0.82rem"><i class="bi bi-person-badge me-1"></i>Access Token</label><input type="text" class="form-control form-control-sm" id="tw-access-' + pid + '" placeholder="e.g. 12345-xY9zW8v..." style="font-family:monospace;font-size:0.82rem"></div>' +
            '<div class="mb-2"><label class="form-label" style="font-size:0.82rem"><i class="bi bi-person-badge-fill me-1"></i>Access Secret</label><input type="password" class="form-control form-control-sm" id="tw-access-secret-' + pid + '" placeholder="e.g. aB3cD4eF5gH6..." style="font-family:monospace;font-size:0.82rem"></div>' +
            '<button class="btn btn-info w-100 mt-2" style="font-weight:600" onclick="saveTwitter(\'' + pid + '\')"><i class="bi bi-check-circle me-1"></i>' + (twitterConnected ? 'Update' : 'Connect') + ' Twitter</button>' +
        '</div>';

        html += '</div></div></div>';
        html += '</div></div>';
    }

    container.innerHTML = html || '<div class="empty-state"><i class="bi bi-plug"></i><h5>No projects found</h5></div>';
}

function toggleTwitterForm(pid) {
    var form = document.getElementById('twitter-form-' + pid);
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

async function saveTwitter(pid) {
    var apiKey = document.getElementById('tw-key-' + pid).value.trim();
    var apiSecret = document.getElementById('tw-secret-' + pid).value.trim();
    var accessToken = document.getElementById('tw-access-' + pid).value.trim();
    var accessSecret = document.getElementById('tw-access-secret-' + pid).value.trim();

    if (!apiKey || !apiSecret || !accessToken || !accessSecret) {
        showToast('All 4 Twitter credentials are required', 'warning');
        return;
    }

    try {
        await fetchAPI('/api/profiles/twitter/' + pid, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ api_key: apiKey, api_secret: apiSecret, access_token: accessToken, access_secret: accessSecret }),
        });
        showToast('Twitter connected successfully!', 'success');
        await loadData();
    } catch (e) {
        showToast('Failed: ' + e.message, 'danger');
    }
}

async function disconnectPlatform(pid, platform) {
    if (!confirm('Disconnect ' + platform + ' from ' + pid + '?')) return;
    try {
        await fetchAPI('/api/profiles/disconnect/' + pid + '/' + platform, { method: 'POST' });
        showToast(platform + ' disconnected', 'success');
        await loadData();
    } catch (e) {
        showToast('Failed: ' + e.message, 'danger');
    }
}

var params = new URLSearchParams(window.location.search);
if (params.get('success')) {
    var proj = params.get('project') || '';
    showToast('LinkedIn connected for ' + (proj || 'project') + '!', 'success');
    history.replaceState({}, '', '/profiles');
}
if (params.get('error')) {
    showToast('Error: ' + decodeURIComponent(params.get('error')), 'danger');
    history.replaceState({}, '', '/profiles');
}

loadData();
</script>
{% endblock %}
